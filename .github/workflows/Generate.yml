# .github/workflows/main.yml (æˆ–å…¶ä»–åç§°)
name: ç”Ÿæˆå¹¶å¤‡ä»½ M3U å’Œ TXT æ’­æ”¾åˆ—è¡¨

on:
  push:
    branches: [ main ]
  workflow_dispatch:      # æ‰‹åŠ¨è§¦å‘

jobs:
  generate_m3u:
    runs-on: ubuntu-latest
    # å…³é”®ï¼šç»™ GITHUB_TOKEN å†™æƒé™
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0      # å®Œæ•´å†å²è®°å½•

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: è¿è¡Œè„šæœ¬ç”Ÿæˆæ’­æ”¾åˆ—è¡¨
        run: |
          python md/test22.py
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”ŸæˆæˆåŠŸ
          ls -l demo_output.m3u tvbox_output.txt

      ---
      
      # ğŸš€ æ­¥éª¤ 1: åˆ›å»ºå¹¶å¤åˆ¶å¤‡ä»½æ–‡ä»¶ (æ–‡ä»¶åå·²ä¿®æ­£)
      - name: åˆ›å»ºå¹¶å¤åˆ¶å¤‡ä»½æ–‡ä»¶
        run: |
          # ä¿®æ­£æ—¶é—´æˆ³æ ¼å¼: MMDDHHMM (ä¾‹å¦‚: 12081157)
          TIMESTAMP=$(date +%m%d%H%M)
          
          # ç¡®ä¿ history ç›®å½•å­˜åœ¨
          mkdir -p history
          
          # â— å…³é”®ä¿®æ­£: æ–‡ä»¶åç°åœ¨æ˜¯ logo${TIMESTAMP}.m3u
          cp demo_output.m3u history/logo${TIMESTAMP}.m3u
          
          # â— å…³é”®ä¿®æ­£: æ–‡ä»¶åç°åœ¨æ˜¯ tvbox_${TIMESTAMP}.txt
          cp tvbox_output.txt history/tvbox_${TIMESTAMP}.txt
          
          echo "å¤‡ä»½æ–‡ä»¶å·²ç”Ÿæˆåˆ° history/ ç›®å½•ï¼Œæ—¶é—´æˆ³ï¼š${TIMESTAMP}"
          
      ---

      # ğŸš€ æ­¥éª¤ 2: æäº¤å¹¶æ¨é€åˆ° main åˆ†æ”¯
      - name: æäº¤å¹¶æ¨é€åˆ° main åˆ†æ”¯
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # ç¡®ä¿æ·»åŠ äº†ä¸»æ–‡ä»¶å’Œæ•´ä¸ª history ç›®å½•
          git add demo_output.m3u tvbox_output.txt
          git add history/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æ›´æ”¹
          if git status --porcelain | grep -q 'demo_output.m3u\|tvbox_output.txt\|history/'; then
            # æäº¤å¹¶æ¨é€æ›´æ”¹
            git commit -m "è‡ªåŠ¨æ›´æ–°æ’­æ”¾åˆ—è¡¨å’Œå†å²å¤‡ä»½" --no-verify
            git push origin HEAD:main
          else
            echo "No new changes to commit. Skipping commit and push."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      ---

      - name: ä¸Šä¼ ç”Ÿæˆçš„æ’­æ”¾åˆ—è¡¨æ–‡ä»¶ä¸º artifact
        uses: actions/upload-artifact@v4
        with:
          name: æ’­æ”¾åˆ—è¡¨
          # ä¸Šä¼ ä¸»è¦çš„ M3U å’Œ TXT æ–‡ä»¶
          path: |
            demo_output.m3u
            tvbox_output.txt
