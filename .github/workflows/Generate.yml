# .github/workflows/Generate.yml
name: ç”Ÿæˆã€å¤‡ä»½ã€åˆå¹¶å¹¶ä¸Šä¼ KVæ’­æ”¾åˆ—è¡¨

on:
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯ 6 å°æ—¶è¿è¡Œä¸€æ¬¡ (00:01, 06:01, 12:01, 18:01 UTC)
    - cron: '1 */6 * * *'

jobs:
  generate_m3u:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          # éœ€è¦å®Œæ•´çš„å†å²è®°å½•æ¥æ¯”è¾ƒæ–‡ä»¶
          fetch-depth: 0 

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # 1. è¿è¡Œä¸»è„šæœ¬ç”Ÿæˆä¸´æ—¶æ–‡ä»¶
      - name: è¿è¡Œä¸»è„šæœ¬ç”Ÿæˆä¸´æ—¶æ–‡ä»¶
        run: |
          # è¿è¡Œ Python è„šæœ¬ï¼Œå®ƒä¼šç”Ÿæˆ demo_output.m3u å’Œ tvbox_output.txt
          python md/test22.py
          
          # å°†åŸå§‹æ–‡ä»¶é‡å‘½åä¸º _newï¼Œé˜²æ­¢ä¸æ£€å‡ºçš„æ—§æ–‡ä»¶æ··æ·†
          mv demo_output.m3u demo_output_new.m3u
          mv tvbox_output.txt tvbox_output_new.txt
          echo "ä¸»æ–‡ä»¶ç”Ÿæˆå®Œæˆã€‚"

      # 2. å†…å®¹æ ¡éªŒå¹¶ç»ˆæ­¢å·¥ä½œæµ (å†…å®¹ä¸å˜åˆ™è·³è¿‡åç»­æ‰€æœ‰æ­¥éª¤)
      - name: å†…å®¹æ ¡éªŒå¹¶ç»ˆæ­¢
        id: check_content
        run: |
          # æ£€æŸ¥ä¸Šä¸€æ¬¡æäº¤çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f demo_output.m3u ] && [ -f tvbox_output.txt ]; then
            
            # æ¯”è¾ƒ M3U æ–‡ä»¶ å’Œ TXT æ–‡ä»¶ã€‚cmp -s: å®‰é™æ¨¡å¼ï¼Œ0 è¡¨ç¤ºå†…å®¹ç›¸åŒã€‚
            if cmp -s demo_output_new.m3u demo_output.m3u && cmp -s tvbox_output_new.txt tvbox_output.txt; then
              echo "å†…å®¹æœªæ›´æ”¹ã€‚è·³è¿‡åç»­æ­¥éª¤ã€‚"
              echo "SKIP_UPDATE=true" >> $GITHUB_OUTPUT
              
            else
              echo "å†…å®¹å·²æ›´æ”¹ã€‚ç»§ç»­æ‰§è¡Œæ›´æ–°ã€‚"
              echo "SKIP_UPDATE=false" >> $GITHUB_OUTPUT
            fi
          else
            # å¦‚æœæ—§æ–‡ä»¶ä¸å­˜åœ¨ (ä¾‹å¦‚ç¬¬ä¸€æ¬¡è¿è¡Œ)ï¼Œåˆ™ç»§ç»­æ‰§è¡Œ
            echo "æœªæ‰¾åˆ°æ—§æ–‡ä»¶ã€‚ç»§ç»­æ‰§è¡Œæ›´æ–°ã€‚"
            echo "SKIP_UPDATE=false" >> $GITHUB_OUTPUT
          fi

      # ğŸŒŸ 3. å…³é”®ä¿®å¤ï¼šæ·»åŠ ç‹¬ç«‹çš„é‡å‘½åæ­¥éª¤
      - name: é‡å‘½åä¸´æ—¶æ–‡ä»¶ä¸ºæ­£å¼æ–‡ä»¶å
        if: ${{ steps.check_content.outputs.SKIP_UPDATE != 'true' }}
        run: |
          mv demo_output_new.m3u demo_output.m3u
          mv tvbox_output_new.txt tvbox_output.txt
          echo "ä¸´æ—¶æ–‡ä»¶å·²é‡å‘½åä¸ºæ­£å¼æ–‡ä»¶åã€‚"

      # 4. åˆ›å»ºå¹¶å¤åˆ¶å¤‡ä»½æ–‡ä»¶åˆ° history/ (å¦‚æœå†…å®¹æœ‰å˜åŒ–)
      - name: åˆ›å»ºå¹¶å¤åˆ¶å¤‡ä»½æ–‡ä»¶åˆ° history/
        if: ${{ steps.check_content.outputs.SKIP_UPDATE != 'true' }}
        id: set_timestamp
        run: |
          TIMESTAMP=$(date +%m%d%H%M)
          mkdir -p history
          # æ­¤æ—¶ demo_output.m3u åº”è¯¥å·²ç»å­˜åœ¨ä¸”å¯ç”¨
          cp demo_output.m3u history/logo${TIMESTAMP}.m3u
          cp tvbox_output.txt history/tvbox_${TIMESTAMP}.txt
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_OUTPUT 
          echo "å¤‡ä»½æ–‡ä»¶å·²ç”Ÿæˆåˆ° history/ ç›®å½•ã€‚"

      # 5. è¿è¡Œåˆå¹¶è„šæœ¬ç”Ÿæˆ merged æ–‡ä»¶ (å¦‚æœå†…å®¹æœ‰å˜åŒ–)
      - name: è¿è¡Œåˆå¹¶è„šæœ¬ç”Ÿæˆ merged æ–‡ä»¶
        if: ${{ steps.check_content.outputs.SKIP_UPDATE != 'true' }}
        run: python md/merge_tvlist.py

      # 6. ä¸Šä¼ æ–‡ä»¶åˆ° Cloudflare KV (å¦‚æœå†…å®¹æœ‰å˜åŒ–)
      - name: ä¸Šä¼ æ–‡ä»¶åˆ° Cloudflare KV
        if: ${{ steps.check_content.outputs.SKIP_UPDATE != 'true' }}
        run: |
          TIMESTAMP="${{ steps.set_timestamp.outputs.TIMESTAMP }}"
          ACCOUNT_ID="${{ secrets.CF_ACCOUNT_ID }}"
          NAMESPACE_ID="${{ secrets.CF_KV_NAMESPACE_ID }}"
          API_TOKEN="${{ secrets.CF_API_TOKEN }}"
          
          CF_URL_BASE="https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/storage/kv/namespaces/${NAMESPACE_ID}/values"
          AUTH_HEADER="Authorization: Bearer ${API_TOKEN}"

          echo "--- æ­£åœ¨ä¸Šä¼  6 ä¸ª Key åˆ° KV å­˜å‚¨ ---"

          # æ ¹ç›®å½•æ–‡ä»¶ (2ä¸ª)
          curl -s -X PUT "${CF_URL_BASE}/latest_m3u" --data-binary "@demo_output.m3u" -H "${AUTH_HEADER}" &
          curl -s -X PUT "${CF_URL_BASE}/latest_txt" --data-binary "@tvbox_output.txt" -H "${AUTH_HEADER}" &
          
          # åˆå¹¶æ–‡ä»¶ (2ä¸ª, ä½äº history/)
          curl -s -X PUT "${CF_URL_BASE}/history/merged.m3u" --data-binary "@history/merged.m3u" -H "${AUTH_HEADER}" &
          curl -s -X PUT "${CF_URL_BASE}/history/merged.txt" --data-binary "@history/merged.txt" -H "${AUTH_HEADER}" &
          
          # å¸¦æ—¶é—´æˆ³çš„å¤‡ä»½æ–‡ä»¶ (2ä¸ª, ä½äº history/)
          curl -s -X PUT "${CF_URL_BASE}/history/logo_${TIMESTAMP}.m3u" --data-binary "@history/logo${TIMESTAMP}.m3u" -H "${AUTH_HEADER}" &
          curl -s -X PUT "${CF_URL_BASE}/history/tvbox_${TIMESTAMP}.txt" --data-binary "@history/tvbox_${TIMESTAMP}.txt" -H "${AUTH_HEADER}" &
          
          wait
          echo "Cloudflare KV 6 æ–‡ä»¶ä¸Šä¼ å®Œæˆã€‚"
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}

      # 7. è¿è¡Œ Cloudflare KV æ¸…ç†è„šæœ¬ (å¦‚æœå†…å®¹æœ‰å˜åŒ–)
      - name: æ¸…ç† Cloudflare KV ä¸­çš„æ—§å¤‡ä»½ Key
        if: ${{ steps.check_content.outputs.SKIP_UPDATE != 'true' }}
        # ç¡®ä¿ md/clear_kv.py èƒ½å¤Ÿè¯»å–å’Œä½¿ç”¨æä¾›çš„ç¯å¢ƒå˜é‡
        run: |
          echo "æ­£åœ¨æ‰§è¡Œ KV æ¸…ç†..."
          python md/clear_kv.py
          echo "KV æ¸…ç†å®Œæˆã€‚"
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}

      # 8. æäº¤æ‰€æœ‰æ›´æ”¹ (å¦‚æœå†…å®¹æœ‰å˜åŒ–)
      - name: æäº¤å¹¶æ¨é€åˆ° main åˆ†æ”¯
        if: ${{ steps.check_content.outputs.SKIP_UPDATE != 'true' }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add demo_output.m3u tvbox_output.txt
          git add history/
          
          if git status --porcelain | grep -q 'demo_output.m3u\|tvbox_output.txt\|history/'; then
            git commit -m "è‡ªåŠ¨æ›´æ–°ï¼šç”Ÿæˆã€å¤‡ä»½ã€åˆå¹¶å¹¶æ¸…ç† KV" --no-verify
            
            # å…³é”®ä¿®æ­£ï¼šæ‹‰å–è¿œç¨‹æ›´æ”¹å¹¶åˆå¹¶ï¼Œé˜²æ­¢æ¨é€è¢«æ‹’ç»
            echo "å°è¯•æ‹‰å–è¿œç¨‹æ›´æ”¹å¹¶åˆå¹¶..."
            git pull --rebase origin main
            
            git push origin HEAD:main
          else
            echo "No new changes to commit. Skipping commit and push."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      # 9. ä¸Šä¼ ç”Ÿæˆçš„æ’­æ”¾åˆ—è¡¨æ–‡ä»¶ä¸º artifact (å¦‚æœå†…å®¹æœ‰å˜åŒ–)
      - name: ä¸Šä¼ ç”Ÿæˆçš„æ’­æ”¾åˆ—è¡¨æ–‡ä»¶ä¸º artifact
        if: ${{ steps.check_content.outputs.SKIP_UPDATE != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: æ’­æ”¾åˆ—è¡¨
          path: |
            demo_output.m3u
            tvbox_output.txt
