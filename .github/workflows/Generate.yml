# .github/workflows/Generate.yml
name: 生成并备份 M3U 和 TXT 播放列表

on:
  push:
    branches: [ main ]
  workflow_dispatch:      # 手动触发

jobs:
  generate_m3u:
    runs-on: ubuntu-latest
    # 关键：给 GITHUB_TOKEN 写权限
    permissions:
      contents: write

    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0      # 完整历史记录

      - name: 设置 Python 环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: 运行脚本生成播放列表
        run: |
          python md/test22.py
          # 检查文件是否生成成功
          ls -l demo_output.m3u tvbox_output.txt

      # 步骤 1: 创建并复制备份文件
      - name: 创建并复制备份文件
        run: |
          # 修正时间戳格式: MMDDHHMM (例如: 12081157)
          TIMESTAMP=$(date +%m%d%H%M)
          
          # 确保 history 目录存在
          mkdir -p history
          
          # 关键修正: 文件名现在是 logo${TIMESTAMP}.m3u
          cp demo_output.m3u history/logo${TIMESTAMP}.m3u
          
          # 关键修正: 文件名现在是 tvbox_${TIMESTAMP}.txt
          cp tvbox_output.txt history/tvbox_${TIMESTAMP}.txt
          
          echo "备份文件已生成到 history/ 目录，时间戳：${TIMESTAMP}"
          
      # 步骤 2: 提交并推送到 main 分支
      - name: 提交并推送到 main 分支
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # 确保添加了主文件和整个 history 目录
          git add demo_output.m3u tvbox_output.txt
          git add history/
          
          # 检查是否有实际更改
          if git status --porcelain | grep -q 'demo_output.m3u\|tvbox_output.txt\|history/'; then
            # 提交并推送更改
            git commit -m "自动更新播放列表和历史备份" --no-verify
            git push origin HEAD:main
          else
            echo "No new changes to commit. Skipping commit and push."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 上传生成的播放列表文件为 artifact
        uses: actions/upload-artifact@v4
        with:
          name: 播放列表
          # 上传主要的 M3U 和 TXT 文件
          path: |
            demo_output.m3u
            tvbox_output.txt
