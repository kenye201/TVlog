name: ç”Ÿæˆå¹¶ä¸Šä¼  M3U å’Œ TXT æ’­æ”¾åˆ—è¡¨

on:
  push:
    branches: [ main ]
  workflow_dispatch:      # æ‰‹åŠ¨è§¦å‘

jobs:
  generate_m3u:
    runs-on: ubuntu-latest
    # å…³é”®ï¼šç»™ GITHUB_TOKEN å†™æƒé™
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0      # å®Œæ•´å†å²è®°å½•ï¼Œé˜²æ­¢æµ…å…‹éš†å¯¼è‡´ push å¤±è´¥

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: è¿è¡Œè„šæœ¬ç”Ÿæˆ demo_output.m3u å’Œ tvbox_output.txt
        run: |
          python md/test22.py
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”ŸæˆæˆåŠŸ
          ls -l demo_output.m3u tvbox_output.txt

      - name: æäº¤å¹¶æ¨é€åˆ° main åˆ†æ”¯
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # ğŸš€ é‡ç‚¹ä¿®æ­£ 1: åŒæ—¶æ·»åŠ  M3U å’Œ TXT æ–‡ä»¶
          git add demo_output.m3u tvbox_output.txt
          
          # ä½¿ç”¨ 'git diff' æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æ›´æ”¹ï¼Œé¿å…ç©ºæäº¤
          if git diff --staged --quiet; then
            echo "No changes in M3U or TXT files to commit."
          else
            # æäº¤å¹¶æ¨é€æ›´æ”¹
            git commit -m "è‡ªåŠ¨æ›´æ–°æ’­æ”¾åˆ—è¡¨ demo_output.m3u å’Œ tvbox_output.txt" --no-verify
            git push origin HEAD:main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ ç”Ÿæˆçš„æ’­æ”¾åˆ—è¡¨æ–‡ä»¶ä¸º artifact
        uses: actions/upload-artifact@v4
        with:
          name: æ’­æ”¾åˆ—è¡¨
          # ğŸš€ é‡ç‚¹ä¿®æ­£ 2: ä¸Šä¼  M3U å’Œ TXT ä¸¤ä¸ªæ–‡ä»¶
          path: |
            demo_output.m3u
            tvbox_output.txt
