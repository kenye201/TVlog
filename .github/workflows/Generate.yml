# .github/workflows/Generate.yml
name: 生成、备份、合并并上传KV播放列表

on:
  push:
    branches: [ main ]
  workflow_dispatch:      # 手动触发

jobs:
  generate_m3u:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 设置 Python 环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # 1. 生成最新的主要播放列表 (根目录)
      - name: 运行主脚本生成 demo_output.m3u 和 tvbox_output.txt
        run: |
          python md/test22.py
          echo "主文件生成完成。"

      # 2. 生成带时间戳的备份文件 (history 文件夹)
      - name: 创建并复制备份文件到 history/
        run: |
          TIMESTAMP=$(date +%m%d%H%M)
          mkdir -p history
          cp demo_output.m3u history/logo${TIMESTAMP}.m3u
          cp tvbox_output.txt history/tvbox_${TIMESTAMP}.txt
          echo "备份文件已生成到 history/ 目录。"

      # 3. 运行合并脚本生成 merged 文件 (history 文件夹)
      - name: 运行合并脚本生成 merged.m3u 和 merged.txt
        run: |
          python md/merge_tvlist.py
          echo "合并文件生成完成。"

# 4. 上传文件到 Cloudflare KV (使用更健壮的 Bash 变量赋值)
      - name: 上传播放列表到 Cloudflare KV
        run: |
          # 将 Secrets 赋值给局部变量，确保没有隐式换行符或空格干扰
          ACCOUNT_ID="${{ secrets.CF_ACCOUNT_ID }}"
          NAMESPACE_ID="${{ secrets.CF_KV_NAMESPACE_ID }}"
          API_TOKEN="${{ secrets.CF_API_TOKEN }}"

          # 构造 Cloudflare API URL (现在使用局部变量，更安全)
          CF_URL_BASE="https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/storage/kv/namespaces/${NAMESPACE_ID}/values"
          AUTH_HEADER="Authorization: Bearer ${API_TOKEN}"
          
          # 上传 M3U 文件，键名为 latest_m3u
          echo "正在上传 demo_output.m3u 到 KV 存储..."
          curl -s -X PUT "${CF_URL_BASE}/latest_m3u" \
            -H "${AUTH_HEADER}" \
            --data-binary "@demo_output.m3u"
            
          # 上传 TXT 文件，键名为 latest_txt
          echo "正在上传 tvbox_output.txt 到 KV 存储..."
          curl -s -X PUT "${CF_URL_BASE}/latest_txt" \
            -H "${AUTH_HEADER}" \
            --data-binary "@tvbox_output.txt"
          
          echo "Cloudflare KV 上传完成。"
        env:
          # 依然需要在这里声明您在 GitHub Secrets 中设置的三个变量
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
