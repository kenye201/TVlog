# .github/workflows/Generate.yml
name: ç”Ÿæˆã€å¤‡ä»½ã€åˆå¹¶å¹¶ä¸Šä¼ KVæ’­æ”¾åˆ—è¡¨

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate_m3u:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # 1. ç”Ÿæˆæœ€æ–°çš„ä¸»è¦æ’­æ”¾åˆ—è¡¨ (æ ¹ç›®å½•)
      - name: è¿è¡Œä¸»è„šæœ¬ç”Ÿæˆ demo_output.m3u å’Œ tvbox_output.txt
        run: |
          python md/test22.py
          echo "ä¸»æ–‡ä»¶ç”Ÿæˆå®Œæˆã€‚"

      # 2. ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„å¤‡ä»½æ–‡ä»¶ (history æ–‡ä»¶å¤¹)
      - name: åˆ›å»ºå¹¶å¤åˆ¶å¤‡ä»½æ–‡ä»¶åˆ° history/
        # â— æ³¨æ„ï¼šåœ¨è¿™é‡Œè®¾ç½® TIMESTAMP å˜é‡ï¼Œå¹¶åœ¨åç»­æ­¥éª¤ä¸­å¤ç”¨å®ƒ
        id: set_timestamp
        run: |
          TIMESTAMP=$(date +%m%d%H%M)
          mkdir -p history
          cp demo_output.m3u history/logo${TIMESTAMP}.m3u
          cp tvbox_output.txt history/tvbox_${TIMESTAMP}.txt
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_OUTPUT # å¯¼å‡º TIMESTAMP å˜é‡
          echo "å¤‡ä»½æ–‡ä»¶å·²ç”Ÿæˆåˆ° history/ ç›®å½•ã€‚"

      # 3. è¿è¡Œåˆå¹¶è„šæœ¬ç”Ÿæˆ merged æ–‡ä»¶ (history æ–‡ä»¶å¤¹)
      - name: è¿è¡Œåˆå¹¶è„šæœ¬ç”Ÿæˆ merged.m3u å’Œ merged.txt
        run: |
          python md/merge_tvlist.py
          echo "åˆå¹¶æ–‡ä»¶ç”Ÿæˆå®Œæˆã€‚"

# 4. ä¸Šä¼ æ–‡ä»¶åˆ° Cloudflare KV (ç¡®ä¿ Key ä¸­åŒ…å« history/)
      - name: ä¸Šä¼ æ‰€æœ‰æ’­æ”¾åˆ—è¡¨åˆ° Cloudflare KV
        run: |
          # ... (Secrets and URL setup remains the same)
          TIMESTAMP="${{ steps.set_timestamp.outputs.TIMESTAMP }}"
          ACCOUNT_ID="${{ secrets.CF_ACCOUNT_ID }}"
          NAMESPACE_ID="${{ secrets.CF_KV_NAMESPACE_ID }}"
          API_TOKEN="${{ secrets.CF_API_TOKEN }}"
          
          CF_URL_BASE="https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/storage/kv/namespaces/${NAMESPACE_ID}/values"
          AUTH_HEADER="Authorization: Bearer ${API_TOKEN}"

          echo "--- æ­£åœ¨ä¸Šä¼  8 ä¸ª Key åˆ° KV å­˜å‚¨ ---"

          # æ ¹ç›®å½•æ–‡ä»¶ (Key æ— è·¯å¾„)
          curl -s -X PUT "${CF_URL_BASE}/latest_m3u" --data-binary "@demo_output.m3u" -H "${AUTH_HEADER}" &
          curl -s -X PUT "${CF_URL_BASE}/latest_txt" --data-binary "@tvbox_output.txt" -H "${AUTH_HEADER}" &
          
          # å†å²æ–‡ä»¶å¤¹æ–‡ä»¶ (Key åŒ…å«è·¯å¾„ history/)
          curl -s -X PUT "${CF_URL_BASE}/history/merged.m3u" --data-binary "@history/merged.m3u" -H "${AUTH_HEADER}" &
          curl -s -X PUT "${CF_URL_BASE}/history/merged.txt" --data-binary "@history/merged.txt" -H "${AUTH_HEADER}" &
          
          curl -s -X PUT "${CF_URL_BASE}/history/logo_${TIMESTAMP}.m3u" --data-binary "@history/logo${TIMESTAMP}.m3u" -H "${AUTH_HEADER}" &
          curl -s -X PUT "${CF_URL_BASE}/history/tvbox_${TIMESTAMP}.txt" --data-binary "@history/tvbox_${TIMESTAMP}.txt" -H "${AUTH_HEADER}" &
          
          # å›ºå®šåˆ«å Key (2ä¸ª)
          curl -s -X PUT "${CF_URL_BASE}/history/latest_backup_logo.m3u" --data-binary "@history/logo${TIMESTAMP}.m3u" -H "${AUTH_HEADER}" &
          curl -s -X PUT "${CF_URL_BASE}/history/latest_backup_tvbox.txt" --data-binary "@history/tvbox_${TIMESTAMP}.txt" -H "${AUTH_HEADER}" &

          wait
          echo "Cloudflare KV ä¸Šä¼ å®Œæˆã€‚"
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}

# 5. æäº¤æ‰€æœ‰æ›´æ”¹ (æ–°å¢ git pull/rebase é€»è¾‘)
      - name: æäº¤å¹¶æ¨é€åˆ° main åˆ†æ”¯
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # ç¡®ä¿æ·»åŠ äº†æ‰€æœ‰æ›´æ”¹ (ç”Ÿæˆçš„æ–‡ä»¶å’Œå†å²æ–‡ä»¶å¤¹)
          git add demo_output.m3u tvbox_output.txt
          git add history/
          
          if git status --porcelain | grep -q 'demo_output.m3u\|tvbox_output.txt\|history/'; then
            # æäº¤æ›´æ”¹
            git commit -m "è‡ªåŠ¨æ›´æ–°ï¼šç”Ÿæˆã€å¤‡ä»½ã€åˆå¹¶å¹¶ä¸Šä¼  KV" --no-verify
            
            # ğŸŒŸ å…³é”®ä¿®æ­£ï¼šåœ¨æ¨é€ä¹‹å‰ï¼Œæ‹‰å–è¿œç¨‹çš„æœ€æ–°æ›´æ”¹å¹¶åˆå¹¶ (ä½¿ç”¨ rebase ä¿æŒå†å²è®°å½•çº¿æ€§)
            echo "å°è¯•æ‹‰å–è¿œç¨‹æ›´æ”¹å¹¶åˆå¹¶..."
            git pull --rebase origin main
            
            # æ¨é€åˆå¹¶åçš„æ›´æ”¹
            git push origin HEAD:main
          else
            echo "No new changes to commit. Skipping commit and push."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
