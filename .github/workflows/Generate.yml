# .github/workflows/Generate.yml
name: ç”Ÿæˆã€å¤‡ä»½å¹¶åˆå¹¶æ’­æ”¾åˆ—è¡¨

on:
  push:
    branches: [ main ]
  workflow_dispatch:      # æ‰‹åŠ¨è§¦å‘

jobs:
  generate_m3u:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0      # å®Œæ•´å†å²è®°å½•

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # 1. ç”Ÿæˆæœ€æ–°çš„ä¸»è¦æ’­æ”¾åˆ—è¡¨ (æ ¹ç›®å½•)
      - name: è¿è¡Œä¸»è„šæœ¬ç”Ÿæˆ demo_output.m3u å’Œ tvbox_output.txt
        run: |
          python md/test22.py
          echo "ä¸»æ–‡ä»¶ç”Ÿæˆå®Œæˆã€‚"

      # 2. ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„å¤‡ä»½æ–‡ä»¶ (history æ–‡ä»¶å¤¹)
      - name: åˆ›å»ºå¹¶å¤åˆ¶å¤‡ä»½æ–‡ä»¶åˆ° history/
        run: |
          # ä¿®æ­£æ—¶é—´æˆ³æ ¼å¼: MMDDHHMM (ä¾‹å¦‚: 12081157)
          TIMESTAMP=$(date +%m%d%H%M)
          mkdir -p history
          
          # ç”Ÿæˆ 2 ä¸ªæ–°çš„å¤‡ä»½æ–‡ä»¶
          cp demo_output.m3u history/logo${TIMESTAMP}.m3u
          cp tvbox_output.txt history/tvbox_${TIMESTAMP}.txt
          
          echo "å¤‡ä»½æ–‡ä»¶å·²ç”Ÿæˆåˆ° history/ ç›®å½•ã€‚"
          
      # 3. è¿è¡Œåˆå¹¶è„šæœ¬ç”Ÿæˆ merged æ–‡ä»¶ (history æ–‡ä»¶å¤¹)
      - name: è¿è¡Œåˆå¹¶è„šæœ¬ç”Ÿæˆ merged.m3u å’Œ merged.txt
        run: |
          python md/merge_tvlist.py
          echo "åˆå¹¶æ–‡ä»¶ç”Ÿæˆå®Œæˆã€‚"

      # 4. æäº¤æ‰€æœ‰æ›´æ”¹ (æ ¹ç›®å½• 2 ä¸ª + history æ–‡ä»¶å¤¹ 4 ä¸ª)
      - name: æäº¤å¹¶æ¨é€åˆ° main åˆ†æ”¯
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # ç¡®ä¿æ·»åŠ äº†æ‰€æœ‰æ›´æ”¹
          git add demo_output.m3u tvbox_output.txt
          git add history/
          
          if git status --porcelain | grep -q 'demo_output.m3u\|tvbox_output.txt\|history/'; then
            git commit -m "è‡ªåŠ¨æ›´æ–°ï¼šç”Ÿæˆã€å¤‡ä»½å¹¶åˆå¹¶æ’­æ”¾åˆ—è¡¨" --no-verify
            git push origin HEAD:main
          else
            echo "No new changes to commit. Skipping commit and push."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ä¸Šä¼ ç”Ÿæˆçš„æ’­æ”¾åˆ—è¡¨æ–‡ä»¶ä¸º artifact
        uses: actions/upload-artifact@v4
        with:
          name: æ’­æ”¾åˆ—è¡¨
          # ä»…ä¸Šä¼ ä¸»æ–‡ä»¶
          path: |
            demo_output.m3u
            tvbox_output.txt
# ... (åœ¨ "è¿è¡Œåˆå¹¶è„šæœ¬ç”Ÿæˆ merged.m3u å’Œ merged.txt" æ­¥éª¤ä¹‹å)

      # ğŸš€ æ–°å¢æ­¥éª¤: ä¸Šä¼ æ–‡ä»¶åˆ° Cloudflare KV
      - name: ä¸Šä¼ æ’­æ”¾åˆ—è¡¨åˆ° Cloudflare KV
        run: |
          # æå– Secrets åˆ°ç¯å¢ƒå˜é‡
          CF_URL_BASE="https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_KV_NAMESPACE_ID }}/values"
          AUTH_HEADER="Authorization: Bearer ${{ secrets.CF_API_TOKEN }}"
          
          # 1. ä¸Šä¼  M3U æ–‡ä»¶ (Key: latest_m3u)
          echo "æ­£åœ¨ä¸Šä¼  demo_output.m3u åˆ° KV å­˜å‚¨..."
          curl -X PUT "${CF_URL_BASE}/latest_m3u" \
            -H "${AUTH_HEADER}" \
            --data-binary "@demo_output.m3u"
            
          # 2. ä¸Šä¼  TXT æ–‡ä»¶ (Key: latest_txt)
          echo "æ­£åœ¨ä¸Šä¼  tvbox_output.txt åˆ° KV å­˜å‚¨..."
          curl -X PUT "${CF_URL_BASE}/latest_txt" \
            -H "${AUTH_HEADER}" \
            --data-binary "@tvbox_output.txt"
          
          echo "Cloudflare KV ä¸Šä¼ å®Œæˆã€‚"
        env:
          # å¿…é¡»åœ¨è¿™é‡Œå£°æ˜æ‚¨åœ¨ GitHub Secrets ä¸­è®¾ç½®çš„ä¸‰ä¸ªå˜é‡
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}

# ... (åœ¨æ­¤ä¹‹åæ˜¯ "æäº¤å¹¶æ¨é€åˆ° main åˆ†æ”¯" æ­¥éª¤)
