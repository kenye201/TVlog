# .github/workflows/cleanup.yml
name: 历史记录清理 (去重)

on:
  # 1. 定时触发：每周日凌晨 00:00 UTC 运行
  schedule:
    - cron: '0 0 * * 0' 
  
  # 2. 手动触发：允许您随时在 GitHub Actions 页面手动运行
  workflow_dispatch:
  
jobs:
  cleanup_history:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 必须深度克隆，以便提交更改

      - name: 设置 Python 环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 1. 运行清理脚本删除重复的备份文件
      - name: 运行清理脚本删除重复的备份文件
        run: |
          # 确保脚本路径正确
          python md/cleanup_history.py
          echo "历史记录清理完成。"

      # 2. 提交清理结果
      - name: 提交清理后的更改
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # 仅添加 history 文件夹中的更改（删除的文件）
          git add history/
          
          # 检查是否有文件被删除或修改，避免空提交
          if git status --porcelain | grep -q 'history/'; then
            # 使用 --allow-empty 确保即使只删除了文件也执行提交
            git commit -m "Cleanup: 自动清理 history/ 文件夹中的重复备份文件" --allow-empty
            git push origin HEAD:main
          else
            echo "历史文件夹中没有重复文件，无需提交。"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
