# .github/workflows/cleanup_history.yml
name: 2. 重复备份文件清理 (去重)

on:
  workflow_dispatch:
    # 允许手动触发
  schedule:
    # 在主工作流 (0分) 运行后 5 分钟运行
    - cron: '5 */6 * * *' 

jobs:
  cleanup_history:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: 设置 Python 环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          # 确保安装了 requests，尽管清理脚本本身可能不需要，但这是标准做法
          pip install requests

      # 1. 运行清理脚本删除重复的备份文件
      - name: 运行清理脚本删除重复的备份文件
        run: |
          # 脚本路径使用您最终提供的名称
          python md/cleanup_history.py
          echo "历史记录清理完成。"

      # 2. 提交清理结果
      - name: 提交清理后的更改
        run: |
          git config user.name "GitHub Actions Cleanup"
          git config user.email "actions@github.com"
          
          # 仅添加 history 文件夹中的更改（被删除的文件）
          git add history/
          
          # 检查是否有文件被删除或修改，避免空提交
          # git diff --cached --quiet --exit-code 检查暂存区是否有差异
          if git diff --cached --quiet --exit-code; then
            echo "历史文件夹中没有重复文件，无需提交。"
          else
            # 提交并推送更改
            git commit -m "自动清理：移除重复的 history 备份"
            git pull --rebase origin main # 确保与远程同步
            git push origin HEAD:main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
