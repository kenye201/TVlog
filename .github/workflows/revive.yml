name: IPTV Daily Discovery

on:
  schedule:
    # 每天北京时间凌晨 04:00 运行 (UTC 20:00)
    - cron: '0 20 * * *'
  workflow_dispatch: # 关键：这行允许你在 GitHub Actions 页面手动点击运行

jobs:
  discovery:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install requests

    - name: 运行挖矿脚本
      run: python md/discovery.py

    - name: 提交并推送更新
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # 1. 先把远程最新的改动拉下来，避免在你挖矿期间别人提交了代码
        git pull --rebase origin main
        
        # 2. 添加修改的文件
        git add md/manual_fix.txt
        
        # 3. 提交，如果没有变化则跳过
        git commit -m "Discovery: 自动挖掘并修复活跃网段" || echo "No changes to commit"
        
        # 4. 推送，如果还是冲突，重试最多 3 次
        n=0
        until [ "$n" -ge 3 ]
        do
           git push origin main && break
           n=$((n+1))
           git pull --rebase origin main
           sleep 5
        done
